<div class="all-form">
  <h1 class="form-title">表单</h1>
  <div id="validation-success"></div>
  <nav id="stepper"></nav>
  <div class="form-content">
    <ul id="panelbar">
      <li id="item1">基本信息
        <div>
          <form id="exampleform"></form>
        </div>
      </li>
      <li id="item2">动态行
        <div>
          <div id="grid"></div>
        </div>
      </li>
      <!-- <li id="item3">明细信息
        <div>
          <div id="info-grid"></div>
        </div>
      </li> -->
    </ul>
    <div id="dialog"></div>
    <div class="oper-btn">
      <button title="保存"><i class="fa fa-save"></i></button>
      <button title="关闭"><i class="fa fa-close"></i></button>
      <button title="提交"><i class="fa fa-check"></i></button>
    </div>
  </div>
</div>
<script type="text/javascript">
  var validationSuccess = $("#validation-success");
  // 状态
  $("#stepper").kendoStepper({
      steps: [{
          label: "新建",
          icon: "home"
      },{
          label: "收货中",
          icon: "gear"
      },{
          label: "货位分配中",
          icon: "attachment"
      },{
          label: "收货完成",
          icon: "save"
      }]
  });

  // panelbar
  $("#panelbar").kendoPanelBar();
  var panelBar = $("#panelbar").data("kendoPanelBar")
  panelBar.expand($('[id^="item"]'))

  // form
  $("#exampleform").kendoForm({
    orientation: "horizontal",
    formData: {
      FirstName: "John",
      LastName: "Doe",
      Email: "john.doe@email.com",
      Country: "1",
      City: "Strasbourg",
      AddressLine: new Date(),
      Effective: false,
      Remark: 'erereeeeeee'
    },
    layout: "grid",
    grid: {
      cols: 2,
      // gutter: 20
    },
    items: [
      {
        type: "group",
        layout: "grid",
        grid: { cols: 1, gutter: 10 },
        items: [
          {
            field: "FirstName",
            label: "First Name:",
            editor: 'AutoComplete',
            editorOptions: {
              enable: false
            }
          },
          {
            field: "LastName",
            label: "Last Name:",
            editor: "NumericTextBox",
            validation: { required: true }
          },
          {
            field: "Email",
            label: "Email",
            validation: {
              required: true,
              email: true
            }
          }
        ]
      },
      {
        type: "group",
        layout: "grid",
        grid: { cols: 1, gutter: 10 },
        items: [
          {
            field: "Country",
            editor: "DropDownList",
            label: "Country",
            validation: { required: true },
            editorOptions: {
              optionLabel: "Select...",
              dataSource: [
                { Name: "France", Id: 1 },
                { Name: "Germany", Id: 2 },
                { Name: "Italy", Id: 3 },
                { Name: "Spain", Id: 4 }
              ],
              dataTextField: "Name",
              dataValueField: "Id"
            }
          },
          {
            field: "AddressLine",
            label: "Address Line",
            optional: true,
            validation: { required: true }
          },
          {
            field: "Effective",
            label: "Effective",
            editor: "Switch"
          },
        ]
      }, {
        type: "group",
        layout: "grid",
        grid: { cols: 1 },
        colSpan: 2,
        items: [
          {
            field: "Remark",
            label: "Remark:",
          }
        ]
      }
    ],
    validateField: function (e) {
      validationSuccess.html("");
    },
    submit: function (e) {
      e.preventDefault();
      validationSuccess.html("<div class='k-messagebox k-messagebox-success'>Form data is valid!</div>");
    },
    clear: function (ev) {
      validationSuccess.html("");
    }
  });

  // grid
  var dataSource = new kendo.data.DataSource({
    pageSize: 20,
    data: [
      { ProductName: 'wewewe', Category: { CategoryID: 1, CategoryName: "Beverages" }, UnitPrice: 2 }
    ],
    autoSync: true,
    schema: {
      model: {
        id: "ProductID",
        fields: {
          ProductID: { editable: false, nullable: true },
          ProductName: { validation: { required: true } },
          Category: { defaultValue: { CategoryID: 1, CategoryName: "Beverages" } },
          UnitPrice: { type: "number", validation: { required: true, min: 1 } }
        }
      }
    }
  });

  var grid = $("#grid").kendoGrid({
    dataSource: dataSource,
    // pageable: true,
    // height: 350,
    toolbar: ["create"],
    columns: [
      { field: "ProductName", title: "Product Name" },
      { field: "Category", title: "Category", width: "180px", editor: categoryDropDownEditor, template: "#=Category.CategoryName#" },
      { field: "UnitPrice", title: "Unit Price", format: "{0:c}", width: "130px" },
      { command: "destroy", title: " ", width: "150px" }],
    editable: {
      createAt: "bottom"
    },
  });

  grid.bind("save", grid_save);
  function grid_save(e) {
    if (e.values.name !== "") {
      // the user changed the name field
      if (e.values.name !== e.model.name) {
        console.log("name is modified");
      }
    } else {
        e.preventDefault();
        console.log("name cannot be empty");
    }
  }

  function categoryDropDownEditor(container, options) {
    $('<input required name="' + options.field + '"/>')
      .appendTo(container)
      .kendoDropDownList({
        autoBind: false,
        dataTextField: "CategoryName",
        dataValueField: "CategoryID",
        dataSource: [
          { CategoryName: "Beverages", CategoryID: "1" },
          { CategoryName: "Polyester", CategoryID: "2" },
          { CategoryName: "Cotton/Polyester", CategoryID: "3" },
          { CategoryName: "Rib Knit", CategoryID: "4" }
        ]
      });
  }


  // 明细
  var dataSource = new kendo.data.DataSource({
    type: "odata",
    transport: {
      read: "https://demos.telerik.com/kendo-ui/service/Northwind.svc/Employees"
    },
    pageSize: 5,
    serverPaging: true,
    serverSorting: true
  });
  var ids = {};
  var info_data = {};
  var myWindow = $("#dialog")
  $("#info-grid").kendoGrid({
    dataSource: dataSource,
    // pageable:false,
    pageable: {
      // pageSize:5,
      refresh: true
    },
    columns: [
      {
        width: 150, command: [
          {
            name: '选择货位',
            click: function (e) {
              e.preventDefault();
              var tr = $(e.target).closest("tr");
              var data = this.dataItem(tr);
              parentId = data.EmployeeID;
              if (!info_data[parentId]) {
                info_data[parentId] = []
              }

              if (!ids[parentId]) {
                ids[parentId] = []
              }
              //选择货位弹出框
              myWindow.kendoWindow({
                width: "615px",
                title: "Rams's Ten Principles of Good Design",
                content: "./window.html"
              });
              myWindow.data("kendoWindow").center().open();
            }
          }
        ]
      },
      {
        field: "FirstName",
        title: "First Name",
        width: "120px"
      },
      {
        field: "LastName",
        title: "Last Name",
        width: "120px"
      },
      {
        field: "Country",
        width: "120px"
      },
      {
        field: "City",
        width: "120px"
      },
      {
        field: "Title"
      }
    ],
    detailTemplate: '<div id="split-grid"></div>',
    detailExpand: function (e) {
      var id = this.dataItem(e.masterRow).EmployeeID
      e.detailRow.find("#split-grid").data("kendoGrid").dataSource.read({
        data: info_data[id]
      })
      // 点击展开时，添加自定义属性
      e.masterRow.attr("data-id", id);
    },
    detailInit: function (e) {
      var id = this.dataItem(e.detailRow.prev("tr")).EmployeeID;
      info_data[id] = [{ OrderID: 10258, ShipAddress: "Kirchgasse 6" }];
      ids[id] = [10258];
      e.detailRow.find("#split-grid").kendoGrid({
        dataSource: {
          // data: info_data[id],
          // pageSize:10,
          transport: {
            //动态改变数据的时候
            read: function (operation) {
              var data = operation.data.data || [];
              operation.success(data);
            }
          },
          // autoSync: true,
          schema: {
            model: {
              fields: {
                ShipCountry: { editable: false },
                OrderID: { editable: false },
              }
            }
          }
        },
        // toolbar:[
        //     { name:'save' }
        // ],
        editable: true,
        columns: [
          { width: 150, command: 'destroy' },
          {
            field: "ShipCountry", title: "入库货位", width: 200,
            attributes: { class: 'cargopositionNo' },
            editable: function () { return true }
          },
          {
            field: "ShipAddress", title: "入库工装数量", width: 200,
            attributes: { class: 'toolNumber' },
            editable: function () { return false }
          },
          { field: 'OrderID', title: '&nbsp;', editable: function () { return false } }
        ],

        pageable: false
      })
    },
    dataBinding: function (e) {
      if (e.action === "itemchange") {
        e.preventDefault();
      }
    },
    dataBound: function () {
      // 获取当前点击行的index值
      var commands = $("#info-grid .k-master-row .k-command-cell a");
      for (var i = 0; i < commands.length; i++) {
        var a = commands[i];
        //给每个className为child的元素添加index属性;
        a.index = i;
        a.onclick = function () {
          // alert(this.index)
          index = this.index;
        }
      }
    }
  })

  // operBtn
  var tooltip = $(".oper-btn").kendoTooltip({
    filter: "button",
    position: "right",
    animation: {
      open: {
        effects: "zoom",
        duration: 150
      }
    }
  }).data("kendoTooltip");

  $('.fa-save').on('click', function () {
    $("#exampleform").find('.k-form-submit').trigger('click')
    console.log($('#grid').data("kendoGrid")._data)
    grid.save
    console.log(grid)
  })

  $('.fa-close').on('click', function () {
    let idx = $('.k-state-active').attr('aria-controls').split('-')[1]
    $("#tabstrip").data("kendoTabStrip").remove(idx - 1);
    $("#tabstrip").data("kendoTabStrip").select(0);
  })

  // 必填
  $('input[required="required"]').closest('.k-form-field').find('label').addClass('required')

</script>