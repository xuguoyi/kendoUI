<!DOCTYPE html>
<html id="html">
<head>
  <title>menu</title>
  <meta charset="utf-8">
  <link href="../../styles/all.css" rel="stylesheet">
</head>

<body>
  <header class="menu">
    <ul id="horizontalMenu">
        <li>
          <div class="logo">原材料控制系统</div>
        </li>
      <li style="margin-left: calc(100% - 1000px)">
        Demo
        <ul>
          <li url="./form.html">表单</li>
          <li url="./frozen.html">Frozen and Editable</li>
          <li>Knitwear</li>
          <li>Shirts</li>
          <li>Belts</li>
          <li>Socks</li>
          <li>Fan Zone</li>
        </ul>
      </li>
      <li>
        Ladies
        <ul>
          <li>Jackets and Coats</li>
          <li>Jeans</li>
          <li>Knitwear</li>
          <li>Shirts</li>
          <li>Belts</li>
          <li>Socks</li>
          <li>Fan Zone</li>
        </ul>
      </li>
      <li>
        Kids
        <ul>
          <li>Jackets and Coats</li>
          <li>Jeans</li>
          <li>Knitwear</li>
          <li>Shirts</li>
          <li>Belts</li>
          <li>Socks</li>
          <li>Fan Zone</li>
        </ul>
      </li>
      <li>Sports</li>
      <li>Brands</li>
      <li url="./accessories.html">Accessories</li>
      <li url="./promotions.html">Promotions</li>
      <li><i class="fa fa-user-circle"></i>
        <ul>
          <li>厂区</li>
          <li>修改密码</li>
        </ul>
      </li>
      <li><i class="fa fa-info"></i></li>
      <li><i class="fa fa-repeat"></i></li>
    </ul>
  </header>
  <div id="tabstrip"></div>
  <div class="oper-tab">
    <i class="fa fa-bars"></i>
    <div class="oper-btn">
      <div class="close-other">关闭其它</div>
      <div class="close-all">关闭所有</div>
    </div>
  </div>
  <div id="changeThemeWindow"></div>

  <script type="text/javascript" src="../../js/require.js" data-main="../../js/main.js"></script>
  <script type="text/x-kendo-template" id="allTheme">
    
  </script>
  <script>
    function requireReady() {
      var themeWindow = $("#changeThemeWindow")
      $("#horizontalMenu").kendoMenu({
        scrollable: true
      });

      // changeTheme
      $('.fa-info').closest('li').click(function() {
        openThemeDialog()
      })
      function openThemeDialog() {
        themeWindow.kendoWindow({
          width: "615px",
          title: "Change Theme",
          content: "./theme.html"
        });
        themeWindow.data("kendoWindow").center().open();
      }

      // 初始化tab
      var tabstrip = $("#tabstrip").kendoTabStrip({
        // animation: { open: { effects: "fadeIn" } },
        dataTextField: "text",
        dataContentUrlField: "ContentUrl",
        dataSource: [
          {
            text: "首页",
            ContentUrl: "./app.html"
          }
        ]
      }).data('kendoTabStrip')
      var tabToActivate = $("#tabstrip li:first")
      tabstrip.activateTab(tabToActivate)

      // 移除tab
      var configureCloseTab = function () {
        var tabsElements = $('#tabstrip li[role="tab"]:gt(0)');
        tabsElements.append('<span data-type="remove" class="k-link"><span class="k-icon k-i-x"></span></span>');
      };

      tabstrip.tabGroup.on("click", "[data-type='remove']", function (e) {
        e.preventDefault();
        e.stopPropagation();
        var item = $(e.target).closest(".k-item");
        tabstrip.remove(item.index());
        console.log(tabstrip, 'rm')
        if (tabstrip.items().length > 0 && item.hasClass('k-state-active')) {
          tabstrip.select(0);
        }
      });
      configureCloseTab()

      // 添加tab
      $("#horizontalMenu li").on("click", function () {
        let text = $(this).text()
        let url = $(this).attr('url')
        if (url && !tabstrip._contentUrls.includes(url)) {
          tabstrip.append(
            [{
              text: text,
              contentUrl: url
            }]
          )
          var tabsElements = $('#tabstrip li[role="tab"]:last-child');
          tabsElements.append('<span data-type="remove" class="k-link"><span class="k-icon k-i-x"></span></span>');
          tabstrip.activateTab(tabsElements)
          contAddHeight()
        }else {
          let n = tabstrip._contentUrls.indexOf(url)
          tabstrip.select(n)
        }
      })
      // 计算tab内高度
      function contAddHeight() {
        $('#tabstrip>.k-content').addClass("selected")
      }
      contAddHeight()

      // localStorage获取theme
      if(localStorage.getItem("theme")) {
        initPageTheme(localStorage.getItem("theme"));
      }

      function initPageTheme(themeUrl){
        let $theme = $('#page-theme');
        if(!$theme.length){
          $theme = $('<link rel="stylesheet" href="'+themeUrl+'" id="page-theme">').insertAfter($('head'));
        }else{
          $theme.attr('href', themeUrl);
        }
      }

      // 关闭其它
      $('.close-other').click(function() {
        let n = $('#tabstrip li[role="tab"]').length
        let idx = $('.k-state-active').attr('aria-controls').split('-')[1]
        for(let i=1; i<idx-1; i++) {
          tabstrip.remove(1)
        }
        for(let i=2; i<n; i++) {
          tabstrip.remove(2)
        }
        tabstrip.select(1)
      })

      // 关闭所有
      $('.close-all').click(function() {
        let n = $('#tabstrip li[role="tab"]').length
        for(let i=1; i<n; i++) {
          tabstrip.remove(1)
        }
        tabstrip.select(0)
      })

    };
  </script>



</body>

</html>